# Decision Log

This file records architectural and implementation decisions using a list format.
2025-04-23 15:51:00 - Log of updates made.
2025-04-23 16:06:00 - Добавлена информация о ключевых архитектурных решениях в пакетах i18n-core, i18n-react и i18n-node.

## Архитектурные решения

### [2025-04-23] Создание Memory Bank

**Решение:** Создать Memory Bank для отслеживания контекста проекта i18n инструментов DATAUI.

**Обоснование:** Memory Bank позволит лучше отслеживать контекст проекта, архитектурные решения, прогресс работы и открытые вопросы. Это особенно важно для проекта с множеством компонентов и инструментов, которые должны работать согласованно.

**Детали реализации:**
- Создана директория `memory-bank`
- Созданы основные файлы:
  - `productContext.md` - общее описание проекта
  - `activeContext.md` - текущий статус
  - `progress.md` - отслеживание прогресса
  - `decisionLog.md` - запись решений
  - `systemPatterns.md` - документирование паттернов

### [Предыдущие решения, восстановленные из анализа кода]

### Монорепозиторий с пакетами

**Решение:** Организовать проект как монорепозиторий с несколькими пакетами.

**Обоснование:** Монорепозиторий позволяет легче управлять зависимостями между пакетами, обеспечивает единую систему сборки и тестирования, упрощает внесение изменений, затрагивающих несколько пакетов.

**Детали реализации:**
- Использование pnpm для управления зависимостями
- Использование nx для запуска команд
- Структура директорий с пакетами в директории `packages/`

### Компонентный подход к хранению текстов

**Решение:** Использовать компонентный подход к хранению текстов, где каждый компонент имеет свой i18n файл с переводами.

**Обоснование:** Такой подход обеспечивает лучшую инкапсуляцию, упрощает поддержку и обновление переводов, позволяет оптимизировать загрузку только нужных переводов.

**Детали реализации:**
- Каждый компонент имеет свой i18n.ts файл
- Использование функции `createMessages` для создания переводов
- Экспорт функций `t` и компонента `Message` для использования в компоненте

### Использование FormatJS как основы

**Решение:** Использовать FormatJS как основу для i18n библиотек.

**Обоснование:** FormatJS - это зрелая и широко используемая библиотека для интернационализации, которая поддерживает ICU Message Format, имеет хорошую производительность и активно поддерживается.

**Детали реализации:**
- Создание обертки над FormatJS в пакете i18n-core
- Расширение функциональности для поддержки компонентного подхода
- Добавление поддержки Markdown и Rich Text

### Миграция с устаревших систем i18n

**Решение:** Разработать инструменты для миграции с устаревших систем i18n.

**Обоснование:** Для облегчения перехода существующих проектов на новую систему i18n необходимы инструменты автоматической миграции.

**Детали реализации:**
- Анализ исходного кода для поиска использования i18n
- Создание плана миграции
- Трансформация кода для использования новой системы i18n
- Создание новых i18n файлов с переводами

### [2025-04-23] Архитектура пакетов i18n-core, i18n-react и i18n-node

**Решение:** Разделить функциональность i18n на три основных пакета: i18n-core (базовая функциональность), i18n-react (для React-приложений) и i18n-node (для серверных приложений).

**Обоснование:** Разделение функциональности позволяет:
1. Изолировать базовую логику от специфики платформы
2. Минимизировать размер бандла для клиентских приложений
3. Оптимизировать каждый пакет под конкретную среду выполнения
4. Обеспечить более гибкую систему зависимостей

**Детали реализации:**

**i18n-core:**
- Использует FormatJS как базовую библиотеку для интернационализации
- Предоставляет фабричные функции для создания функций работы с сообщениями
- Реализует систему фолбэков для отсутствующих переводов
- Использует мемоизацию для оптимизации производительности
- Не имеет зависимостей от React или Node.js

**i18n-react:**
- Расширяет i18n-core для работы с React
- Интегрируется с react-intl
- Предоставляет компонент Message для отображения переводов
- Поддерживает Rich Text с React-компонентами
- Оптимизирован для клиентского рендеринга

**i18n-node:**
- Адаптирует i18n-core для использования в Node.js
- Поддерживает работу с разными локалями в одном экземпляре приложения
- Оптимизирован для серверного рендеринга
- Не имеет зависимостей от React

### [2025-04-23] Использование Proxy для доступа к сообщениям

**Решение:** Использовать JavaScript Proxy для доступа к сообщениям в i18n-core.

**Обоснование:**
1. Позволяет лениво вычислять значения только при обращении к ним
2. Упрощает API для пользователей библиотеки
3. Обеспечивает прозрачный доступ к переводам
4. Позволяет добавлять дополнительную логику при доступе к свойствам

**Детали реализации:**
```typescript
return new Proxy({} as Record<K, MessageDescriptor>, {
    get(_target, key) {
        const baseMsg = msgs[key as K];

        if (typeof baseMsg === 'undefined') {
            throw new Error(`Not found message for key ${String(key)}`);
        }

        return getMessageDescriptor({
            key,
            message: baseMsg,
            currentLocale: config.getLocale(),
        });
    },
});
```

### [2025-04-23] Система фолбэков для отсутствующих переводов

**Решение:** Реализовать многоуровневую систему фолбэков для отсутствующих переводов.

**Обоснование:**
1. Обеспечивает корректное отображение контента даже при отсутствии перевода
2. Позволяет постепенно добавлять переводы без необходимости сразу переводить все
3. Учитывает региональные особенности языков
4. Предоставляет гибкие настройки поведения при отсутствии перевода

**Детали реализации:**
- Поддержка цепочки фолбэков: ru-kz -> ru -> en
- Возможность использовать ключ в качестве значения по умолчанию
- Опция использования пустой строки в качестве значения по умолчанию
- Возможность выбрасывать исключение при отсутствии перевода

### [2025-04-23] Интеграция с FormatJS в пакете i18n-sync

**Решение:** Реализовать интеграцию с FormatJS через систему плагинов для поддержки различных форматов хранения переводов.

**Обоснование:**
1. FormatJS использует ICU Message Format, который является стандартом для интернационализации
2. Необходимость поддержки React-компонентов FormatJS для упрощения интеграции с React-приложениями
3. Расширенные возможности форматирования (даты, числа, плюральные формы) в ICU Message Format
4. Поддержка Markdown в переводах для более богатого форматирования текста

**Детали реализации:**

**Система плагинов для загрузчиков:**
- Реализация интерфейса `ProjectLoader` для различных форматов хранения переводов
- Создание специального загрузчика `FormatJsProjectLoader` для работы с форматом FormatJS
- Динамическая загрузка загрузчиков в зависимости от типа формата

**Система идентификаторов:**
- Использование формата `keyset.key` для идентификаторов переводов
- Обеспечение уникальности идентификаторов в рамках проекта
- Сохранение идентификаторов в метаданных переводов для совместимости с FormatJS

**Обработка плюральных форм:**
- Автоматическое заполнение пустых плюральных форм для обеспечения консистентности
- Проверка соответствия типов переводов (плюральный/неплюральный) между различными локалями
- Преобразование плюральных форм между форматом Танкера и форматом FormatJS

**Сохранение метаданных:**
- Сохранение идентификаторов, описаний и флагов markdown в метаданных переводов
- Проверка наличия идентификаторов для всех сообщений
- Поддержка дополнительных метаданных для расширенных возможностей форматирования

**Раздельное хранение статусов:**
- Хранение статусов переводов в отдельных JSON-файлах
- Автоматическое установление статуса Approved для пустых переводов с fallback-локалями
- Синхронизация статусов между различными форматами хранения переводов

### [2025-04-23] Архитектура пакета i18n-sync

**Решение:** Разработать инструмент для синхронизации переводов между проектом и системой переводов Танкер.

**Обоснование:**
1. Необходимость единого процесса работы с переводами для разработчиков и переводчиков
2. Упрощение процесса локализации приложений на несколько языков
3. Обеспечение контроля качества переводов через систему статусов
4. Интеграция с системой контроля версий для отслеживания изменений в переводах

**Детали реализации:**

**Структура хранения переводов:**
- Хранение переводов в JSON-файлах в структурированном формате
- Разделение переводов по кейсетам (логическим группам)
- Хранение метаданных и статусов переводов в отдельных файлах
- Поддержка различных форматов хранения переводов через систему лоадеров

**Работа с ветками переводов:**
- Поддержка веток переводов, аналогично Git/Arc
- Возможность создания, слияния и удаления веток
- Защита основной ветки от прямых изменений
- Отслеживание изменений в ветках для создания тикетов на перевод

**Интеграция с Танкером:**
- Использование API Танкера для синхронизации переводов
- Поддержка инкрементальных обновлений для оптимизации процесса синхронизации
- Разрешение конфликтов при слиянии изменений
- Сохранение истории изменений для отслеживания прогресса

**Интеграция с Трекером:**
- Автоматическое создание тикетов на перевод при отправке изменений
- Поддержка различных очередей для разных типов переводов
- Добавление комментариев в тикеты при обновлении переводов
- Уведомление о статусе переводов через тикеты

**CLI-интерфейс:**
- Предоставление набора команд для работы с переводами
- Поддержка интерактивного режима для инициализации проекта
- Генерация отчетов о состоянии переводов
- Автоматизация рутинных операций с переводами

### [2025-04-23] Архитектура пакета i18n-cli

**Решение:** Разработать CLI-инструмент для управления языковыми файлами в проекте.

**Обоснование:**
1. Автоматизация рутинных операций с языковыми файлами
2. Упрощение процесса добавления новых ключей переводов
3. Обнаружение и удаление неиспользуемых ключей
4. Централизованная конфигурация i18n для проекта

**Детали реализации:**

**Конфигурация проекта:**
- Использование файла i18n.config.ts для хранения конфигурации
- Поддержка типизированной конфигурации через TypeScript
- Загрузка конфигурации с помощью cosmiconfig для гибкого поиска файла
- Поддержка настройки локалей, фолбэков и путей к модулям

**Команда create-keys:**
- Анализ исходного кода для поиска вызовов i18n-функций
- Автоматическое добавление отсутствующих ключей в файл i18n.ts
- Добавление импортов i18n-функций, если они отсутствуют
- Поддержка работы с отдельными файлами и директориями

**Команда find-unused:**
- Рекурсивный поиск неиспользуемых ключей в проекте
- Опциональное удаление неиспользуемых ключей
- Генерация отчета о неиспользуемых ключах

**Парсинг исходного кода:**
- Использование TypeScript Compiler API для парсинга AST
- Создание посетителей для обхода AST и поиска вызовов i18n-функций
- Поддержка как обычных вызовов функций, так и JSX-компонентов

**Интеграция с IDE:**
- Разработка расширения для VS Code для удобного создания ключей
- Интеграция с существующими инструментами разработки

### [2025-04-23] Архитектура пакета i18n-babel-plugin

**Решение:** Разработать Babel-плагин для оптимизации поставки файлов с переводами.

**Обоснование:**
1. Оптимизация размера бандла за счет удаления метаданных из сообщений
2. Улучшение производительности за счет предварительной обработки сообщений
3. Автоматизация преобразования Markdown в HTML
4. Улучшение типографики текстов с помощью типографа

**Детали реализации:**

**Трансформация файлов i18n.ts:**
- Плагин обрабатывает только файлы, соответствующие шаблону `i18n.ts`
- Поддерживает различные режимы работы: обычный и "только переводы"
- Использует Babel API для трансформации AST

**Удаление метаданных:**
- Удаляет поля meta из объектов сообщений (id, description и т.д.)
- Сохраняет только переводы для различных локалей

**Преобразование Markdown в HTML:**
- Использует библиотеку @diplodoc/transform для преобразования Markdown в HTML
- Сохраняет параметры в ссылках при преобразовании
- Поддерживает различные Markdown-элементы: заголовки, списки, ссылки и т.д.

**Типографирование текстов:**
- Использует библиотеку typograf для улучшения типографики текстов
- Поддерживает настройку правил типографа
- Позволяет отключать типограф глобально или для отдельных сообщений

**Оптимизация ICU MessageFormat:**
- Минифицирует многострочные ICU MessageFormat сообщения
- Удаляет лишние пробелы и переносы строк
- Оптимизирует синтаксис для уменьшения размера

**Режим "только переводы":**
- Удаляет все импорты из файла
- Заменяет экспорт на экспорт по умолчанию только объекта с переводами
- Поддерживает фолбэки для отсутствующих переводов

### [2025-04-23] Архитектура пакета eslint-plugin-i18n

**Решение:** Разработать набор правил ESLint для обеспечения корректного использования i18n в коде.

**Обоснование:**
1. Автоматизация проверки корректности использования i18n снижает количество ошибок
2. Правила линтинга позволяют обеспечить единообразие кода во всем проекте
3. Автоматическая генерация идентификаторов упрощает работу разработчиков
4. Раннее обнаружение проблем с i18n на этапе разработки

**Детали реализации:**

**Правило restrict-i18n-imports:**
- Запрещает импорт файлов с текстами (`i18n.ts`) из директорий других уровней
- Поддерживает исключения через алиасы и регулярные выражения
- Обеспечивает компонентный подход к хранению текстов

**Правило auto-generate-translation-message-id:**
- Проверяет наличие идентификатора в объекте перевода
- Автоматически генерирует идентификаторы на основе пространства имен и ключа
- Поддерживает настройку формата идентификаторов
- Обеспечивает уникальность идентификаторов с помощью UUID

**Правило detect-incorrect-calls:**
- Проверяет корректность вызовов i18n функций
- Контролирует использование строковых литералов для ключей
- Проверяет правильное количество аргументов
- Контролирует именование переменных с i18n функциями

**Правило string-literal-keys:**
- Проверяет, что ключи в вызовах i18n функций являются строковыми литералами
- Поддерживает проверку как обычных вызовов функций, так и JSX компонентов
- Интегрируется с i18n-cli для обнаружения вызовов i18n

---

2025-04-23 15:51:00 - Первоначальное создание файла.
2025-04-23 16:06:00 - Добавлена информация о ключевых архитектурных решениях в пакетах i18n-core, i18n-react и i18n-node.